# 次期バージョン 機能計画（優先順位つき）

目的: 次のストア提出に含める機能を優先度順に整理し、実装・検証の観点を明確化する。

更新日: 2025-09-06
対象ブランチ: master（CLI手動ビルド運用）

---

## 優先順位一覧（上から順に実装）

1) 母子手帳番号の認証バッジ（最優先）
2) 認証バッジに紐づく利用制限（強制）
3) AIチャットボット機能（既存メッセージ画面に統合）
4) 検索機能（ユーザ/ポスト）

---

## 1) 母子手帳番号の認証バッジ（最優先）

- 目的: 母子手帳番号を設定したユーザに「認証バッジ」を付与する。
- 要件:
  - プロフィール設定に「母子手帳番号」の入力欄を追加（数値/英数、マスク表示）
  - サーバ側で安全に取り扱う（平文保存禁止）。推奨: ソルト付きハッシュ保管 + 入力済みフラグ/審査状態
  - UI上に認証バッジを表示（プロフィール、投稿者表示、ルーム一覧など）
  - エラーハンドリング/リトライ/削除（再申請）
- データモデル（例）:
  - `public.user_profiles` に列追加（Migration）
    - `maternal_id_hash text`（ソルトでハッシュ化した値）
    - `maternal_id_salt text`（十分長いランダム、復号不可）
    - `maternal_verified boolean default false`（認証済み）
    - `maternal_verified_at timestamptz`（認証日時）
  - RPC: `set_maternal_id(p_id text)`（サーバでソルト生成→ハッシュ保存、true返却）
  - RPC: `verify_maternal_id(p_user uuid)`（当面は自己申告=即時認証 or 管理者承認の2段構えのどちらかを選択）
- RLS/権限:
  - 自分の `maternal_*` は本人のみ参照/更新可
  - 認証状態（boolean）は他者にも公開可能（バッジ表示用）
- 受け入れ基準（抜粋）:
  - 入力→保存→バッジ表示が端末再起動後も維持
  - 平文の番号はどの経路/ログにも残らない

---

## 2) 認証バッジに紐づく利用制限（強制）

- 目的: バッジ未所持ユーザの機能制限を実施する。
- 要件（強制）:
  - 認証バッジ未所持ユーザ:
    - ルーム機能の「非公開ルーム」へ参加不可（作成済み/招待含む）
    - AI機能を利用不可（チャット起動ボタン非表示/サーバ側も拒否）
- 実装ポイント:
  - クライアントUI: 入口の表示/導線制御 + 明確な説明（「認証が必要です」）
  - サーバ側: RLS/ポリシーまたはRPCでの検査を追加（特に非公開ルーム join/AI API）
- 受け入れ基準:
  - 未バッジで該当機能に入ろうとすると一貫した文言で止まる
  - バッジ取得後は制限解除

---

## 3) AIチャットボット機能（既存メッセージ画面に統合）

- 目的: 既存の「AIコメント用ユーザ」との1:1チャットを実装し、育児相談などを可能にする。
- 要件:
  - 既存のメッセージ画面UIに「AIとチャット」入口を追加（サイドバー/ボタン等）
  - AIユーザ（既存のAI投稿用ユーザID）とのDMスレッドを作成/再利用
  - 入力→AI応答を流す（AIバックエンドの既存連携を再利用/拡張）
  - バッジ要件を満たさない場合は入口を非表示/ブロック
- ロギング/安全:
  - 個人情報の入力に関する注意文言
  - エラー/レート制限のUI表示
- 受け入れ基準:
  - スレッド作成/送受信が安定
  - バッジによる gating が期待通り動作

---

## 4) 検索機能（ユーザ/ポスト）

- 目的: ユーザ名/表示名、ポスト本文などの全文検索を提供。
- 要件:
  - クライアント: 検索フィールド + 結果リスト（ユーザ/ポストタブ）
  - サーバ: Supabase の全文検索/インデックス（`to_tsvector` や `ilike` 最適化など）
  - RLS: 投稿/プロフィールの公開可視性・ブロック状態に応じた結果制限
- 受け入れ基準:
  - 部分一致/ひらがな/カタカナの揺れに対する挙動の確認（段階的で可）
  - 不正な結果漏れがない（RLSで担保）

---

## 技術タスク一覧（横断）

- マイグレーション
  - user_profiles に `maternal_*` 列追加
  - 必要に応じて検索用インデックス/関数
- RPC/API
  - `set_maternal_id`, `verify_maternal_id` など
  - ルーム参加/AI利用の前置検査（バッジ要件）
- RLS/ポリシー
  - 非公開ルーム参加条件に `maternal_verified = true` を追加
  - AI関連RPC の呼び出しに `maternal_verified = true` を要求
- クライアント
  - プロフィール編集UI（母子手帳番号 + バッジ表示）
  - ゲート制御（入口非表示/ダイアログ）
  - 検索UI（ユーザ/ポスト）
  - AI DM 入口/スレッド

---

## リスク/留意事項

- 個人情報取り扱い: 番号は平文保存NG。ハッシュ + ソルト + 最小権限で運用
- 認証フロー: 即時認証 or 管理者承認の運用を早期に確定
- 検索: パフォーマンス/コスト（インデックス設計/制限）

---

## マイルストーン（案）

- M1: バッジ入力/保存/表示 + 非公開ルーム制限（最優先）
- M2: 非公開ルーム/AI のバッジ連動調整
- M3: AIチャット（送受信/レート制限/安全表示）
- M4: 検索（ユーザ/ポスト）

---

## 受け入れテスト（サマリ）

- 未バッジ: 非公開/AI がブロックされる
- バッジ済: 非公開参加/ルーム作成/AI 利用可能
- 検索: 公開データのみ適切にヒット、非公開データは漏れない
