## 鍵管理・暗号化 運用ノート（Phase 2）

この文書は、サーバー側暗号化（Phase 2）を安全に運用するための注意事項・手順のまとめです。

### 目的
- 母子手帳番号など機微データを**復号可能な形で安全に保護**する
- 鍵漏洩・消失・運用ミスのリスクを最小化する

### 前提
- 暗号鍵は**保存必須**（鍵を失う＝復号不可＝実質データ消失）
- 環境別に別鍵（本番/ステージング/開発）
- 鍵はVault/KMS等の専用ストアで集中管理（DBやコード・app.jsonに置かない）

### どこに置くか（推奨）
- HashiCorp Vault / クラウドKMS（AWS KMS / GCP KMS / Azure Key Vault）
- Supabase環境で `ALTER SYSTEM` が制限される場合：
  - `ALTER DATABASE ... SET app.maternal_key = '<KEY>'` は権限次第（基本はVault優先）
  - 本番は**Vault優先**、GUC（DBパラメータ）は使わないか緊急時フォールバックのみ

### アクセス権限（最小権限）
- 鍵の読み取り権限は**アプリの実行ロールのみ**に付与
- 人間ユーザーの常時アクセスは**禁止**（break-glass手順のみ許可）
- 端末/アプリから鍵を直接取得しない（DB/RPC/Edge Functionsなどサーバー側で復号）

### 監査・アラート
- Vault/KMS の **Auditログ**を有効化（誰がいつ読み出したか）
- 読み出し失敗・異常回数・アクセス増加に対する**アラート**設定

### バックアップ/DR（ディザスタリカバリ）
- Vault/KMSの**スナップショット/レプリケーション**を有効化
- 復旧手順（Runbook）を文書化（保管先・連絡先・権限者）

### ローテーション（定期交換）
- 原則：6–12ヶ月で実施（リスク/規約に合わせ調整）
- 手順（例）
  1. 新鍵をVaultへ登録（`maternal_key_next` など）
  2. 旧鍵で復号 → **新鍵で再暗号化**（全データ移行ジョブ）
  3. 参照先を新鍵へ切替
  4. 旧鍵を無効化/回収
- リハーサル（小さなバッチで往復テスト）を本番前に必須

### 運用のDo/Don't
- Do
  - 鍵はVault/KMSに保存し、**アプリは鍵そのものを扱わない**
  - 鍵の**アクセス権限/TTLを最小化**し、短寿命トークンを使用
  - **監査ログとアラート**を常時有効化
  - 鍵変更の**Runbook**を整備（担当・期日・検証方法）
- Don't
  - レポジトリ/issue/チャットに鍵を貼らない
  - app.json / .env に復号鍵を置かない（Supabase URL/AnonKey とは性質が違う）
  - 鍵の使い回し（開発・本番で同じ鍵）

### Phase 1 との違い
- Phase 1（ハッシュのみ）：鍵不要・復号しない（機能優先）
- Phase 2（暗号化）：**復号鍵が要**。誤運用＝データ消失の重大リスク

### 具体手順（本番）
1) 鍵生成（256bit以上）
   - 例：`openssl rand -hex 32`
2) Vaultへ鍵登録（KV v2 例）
   - `vault kv put secret/prod/maternal_key value=<HEX_KEY>`
3) ポリシー/ロール作成
   - `path "secret/data/prod/maternal_key" { capabilities = ["read"] }`
   - アプリ実行主体に付与（短寿命トークン/ODIC/AppRole）
4) DB/RPCからの参照
   - `public._get_maternal_key()` は **Vault優先**（必要ならGUCフォールバック無効化）
5) 検証
   - サンプル登録/認証（success=true）
   - 監査ログ/Vaultアクセスログに記録が残る
6) ドキュメント化
   - ローテーション、DR、インシデント対応（失効/再発行）のRunbook

### インシデント対応（例）
- 鍵漏洩の疑い
  - 直ちに現鍵を失効 → 新鍵で再暗号化 → 切替
  - 影響範囲調査（読み出し履歴/時間帯/アクター）と報告
- 復号不可・鍵不明
  - 影響データの特定、バックアップ/レプリカからの復旧可否を確認
  - 再発防止（保管/アクセス/DRルールの見直し）

### Supabase固有の注意
- `ALTER SYSTEM` が不可なプランあり → **Vault運用推奨**
- `ALTER DATABASE ... SET app.maternal_key` は権限次第（本番は避ける）
- RPC(Security Definer)からのみ復号へ到達可能にして、**RLS/権限で直接読み出し禁止**

### 補遺：資格情報の扱い
- Supabase URL/AnonKey は**機密度が低め**（公開鍵相当）だが、漏洩でコスト/DoSに繋がるためSecrets管理推奨
- 復号鍵は**最重要機密**。保管・配布・ローテーションの厳格ルールが必須
